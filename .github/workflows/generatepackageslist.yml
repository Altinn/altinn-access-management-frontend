name: Generate packages release

on:
  workflow_dispatch:
      inputs:
        environment:
          type: environment
          description: Select the environment
jobs:
  get-images-list:
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - uses: octokit/request-action@v2.x
        id: get_package_versions
        with:
          route: GET /user/packages/container/altinn-access-management-frontend/versions
          mediaType: | # The | is significant!
            format: raw
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        #id: list_package_versions
      - name: Generates release.yml with package version
        run: |  
         responses='${{ steps.get_package_versions.outputs.data }}'
          output=""
          for release in $(echo $responses | jq '.[] | .name')
          do
             output+="- $release\n          "
          done
          echo $output
          sed 's/\$IMAGES_OPTIONS/$output/g' ${{ github.workspace }}/.github/workflows/release.template.yml > ${{ github.workspace }}/.github/workflows/release.yml
      - name: commit release
          # Stage the file, commit and push
        run: |
          git add ${{ github.workspace }}/.github/workflows/release.yml
          git commit -m "updated package versions"
          git push origin master
